<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>POS System</title>

<style>@media print {
  body * {
    visibility: hidden;
  }

  #print-area, #print-area * {
    visibility: visible;
  }

  #print-area {
    position: absolute;
    top: 0;
    right: 0;
    width: 58mm; /* Ø·Ø§Ø¨Ø¹Ø© Ø­Ø±Ø§Ø±ÙŠØ© */
    font-size: 12px;
    direction: rtl;
  }

  .p-center {
    text-align: center;
  }

  .p-line {
    border-top: 1px dashed #000;
    margin: 6px 0;
  }
}
@media print{
 body{margin:0}
 .no-print{display:none}
 .receipt{width:80mm;font-size:12px}
}
body{margin:0;font-family:Tajawal,Arial;background:#f1f5f9}
header{background:#020617;color:#fff;padding:12px;text-align:center}
nav{display:flex;gap:5px;padding:5px;background:#0f172a}
nav button{flex:1;padding:10px;border:0;border-radius:8px;color:#fff;background:#334155}
.box{background:#fff;border-radius:12px;padding:10px;margin:8px}
input,select,button{width:100%;padding:10px;margin-bottom:6px;border-radius:8px;border:1px solid #cbd5f5;font-size:14px}
button{cursor:pointer;border:0}
.btn{background:#22c55e;color:#fff}
.btn-dark{background:#0f172a;color:#fff}
.btn-danger{background:#ef4444;color:#fff}
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px}
.product{background:#f8fafc;padding:10px;border-radius:10px;text-align:center;border:1px solid #e5e7eb;cursor:pointer}
.low{border:2px solid #ef4444}
.line{display:flex;justify-content:space-between;border-bottom:1px dashed #ccc;padding:4px 0}
.total{font-weight:bold;margin-top:6px}
.hidden{display:none}
.receipt{display:none}
</style>
</head>

<body>

<header>Ù†Ù‚Ø·Ø© Ø¨ÙŠØ¹</header>

<nav class="no-print">
<button onclick="show('cashier')">ğŸ§¾ ÙƒØ§Ø´ÙŠØ±</button>
<button onclick="show('productsMng')">ğŸ“¦ Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
<button onclick="show('customers')">ğŸ‘¤ Ø¹Ù…Ù„Ø§Ø¡</button>
<button onclick="show('reports')">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ±</button>
</nav>

<!-- ========== Ø§Ù„ÙƒØ§Ø´ÙŠØ± ========== -->
<div id="cashier" class="no-print">

<div class="box">
<input id="search" placeholder="Ø§Ø³Ù… Ø£Ùˆ Ø¨Ø§Ø±ÙƒÙˆØ¯" onkeyup="renderProducts()">
<button class="btn-dark" onclick="scanBarcode()">ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
<div class="products" id="products"></div>
</div>

<div class="box">
<select id="payType" onchange="toggleCustomer()">
<option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
<option value="credit">Ø¢Ø¬Ù„</option>
</select>

<select id="customerSelect" class="hidden"></select>

<div id="invoice"></div>

<input id="discount" placeholder="Ø®ØµÙ…">
<select id="discountType" onchange="calc()">
<option value="value">Ù…Ø¨Ù„Øº</option>
<option value="percent">%</option>
</select>

<input id="tax" placeholder="Ø¶Ø±ÙŠØ¨Ø© %">

<div class="total" id="total"></div>
<div class="total" id="net"></div>

<button class="btn-dark" onclick="clearInvoice()">Ù…Ø³Ø­</button>
<button class="btn" onclick="saveInvoice()">Ø­ÙØ¸</button>
<button class="btn" onclick="printInvoice()">Ø·Ø¨Ø§Ø¹Ø©</button>
</div>

</div>

<!-- ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ========== -->
<div id="productsMng" class="hidden no-print">

<div class="box">
<h3>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ ØµÙ†Ù</h3>
<input id="pn" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
<input id="pb" placeholder="Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
<input id="pp" placeholder="Ø³Ø¹Ø± Ø¨ÙŠØ¹">
<input id="pc" placeholder="Ø³Ø¹Ø± Ø´Ø±Ø§Ø¡">
<input id="ps" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
<button class="btn" onclick="addProduct()">Ø­ÙØ¸</button>
</div>

<div class="box">
<h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
<div id="plist"></div>
</div>

</div>

<!-- ========== Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ========== -->
<div id="customers" class="hidden no-print">
<div class="box">
<input id="custName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
<button class="btn" onclick="addCustomer()">Ø¥Ø¶Ø§ÙØ©</button>
</div>
<div class="box" id="customerList"></div>
</div>

<!-- ========== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ========== -->
<div id="reports" class="hidden no-print">
<div class="box" id="dayReport"></div>
</div>

<!-- ========== Ø§Ù„ÙØ§ØªÙˆØ±Ø© ========== -->
<div class="receipt" id="receipt">
<center>
<b>ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</b><br>
<span id="rDate"></span>
</center>
<hr>
<div id="rItems"></div>
<hr>
<b>Ø§Ù„ØµØ§ÙÙŠ: <span id="rNet"></span></b>
<hr>
<center>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…</center>
</div>

<script>
let products=JSON.parse(localStorage.products||"[]");
let customers=JSON.parse(localStorage.customers||"[]");
let invoices=JSON.parse(localStorage.invoices||"[]");
let cart=[];
let invNo=+localStorage.invNo||1;

function show(id){
 ["cashier","productsMng","customers","reports"].forEach(x=>document.getElementById(x).classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
 if(id=="productsMng")renderProductList();
 if(id=="customers")renderCustomers();
 if(id=="reports")renderReports();
}

function renderProducts(){
 let q=search.value||"";
 productsBox.innerHTML="";
 products.filter(p=>p.n.includes(q)||p.b==q).forEach((p,i)=>{
  productsBox.innerHTML+=`
  <div class="product ${p.s<=5?'low':''}" onclick="addItem(${i})">
   <b>${p.n}</b><br>
   ${p.p} Ø¬<br>
   Ù…Ø®Ø²ÙˆÙ†: ${p.s}
  </div>`;
 });
}

function addItem(i){
 let p=products[i];
 if(p.s<=0)return alert("Ù†ÙØ§Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†");
 let f=cart.find(x=>x.n==p.n);
 if(f)f.q++; else cart.push({n:p.n,p:p.p,c:p.c,q:1});
 p.s--;
 localStorage.products=JSON.stringify(products);
 renderInvoice();
}

function renderInvoice(){
 invoice.innerHTML="";
 cart.forEach(i=>{
  invoice.innerHTML+=`<div class="line"><span>${i.n} Ã— ${i.q}</span><span>${i.p*i.q}</span></div>`;
 });
 calc();
}

function calc(){
 let total=cart.reduce((a,i)=>a+i.p*i.q,0);
 let d=+discount.value||0;
 if(discountType.value=="percent") d=total*(d/100);
 let net=total-d+(total-d)*(+tax.value||0)/100;
 totalDiv.innerText="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: "+total;
 netDiv.innerText="Ø§Ù„ØµØ§ÙÙŠ: "+net.toFixed(2);
 window._net=net;
}

function clearInvoice(){
 cart=[];
 discount.value=tax.value="";
 renderInvoice();
}

function saveInvoice(){
 if(cart.length==0)return;
 invoices.push({no:invNo,date:new Date().toISOString(),net:_net});
 localStorage.invoices=JSON.stringify(invoices);
 localStorage.invNo=++invNo;
 clearInvoice();
 alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
}

function printInvoice(){
 rItems.innerHTML="";
 cart.forEach(i=>rItems.innerHTML+=`<div>${i.n} Ã— ${i.q}</div>`);
 rNet.innerText=_net;
 rDate.innerText=new Date().toLocaleString();
 receipt.style.display="block";
 window.print();
 receipt.style.display="none";
 saveInvoice();
}

function addProduct(){
 products.push({
  n:pn.value,b:pb.value,p:+pp.value,c:+pc.value,s:+ps.value
 });
 localStorage.products=JSON.stringify(products);
 pn.value=pb.value=pp.value=pc.value=ps.value="";
 renderProductList();
}

function renderProductList(){
 plist.innerHTML="";
 products.forEach(p=>{
  plist.innerHTML+=`<div class="line">${p.n} | Ù…Ø®Ø²ÙˆÙ† ${p.s}</div>`;
 });
}

function addCustomer(){
 customers.push({name:custName.value,balance:0});
 localStorage.customers=JSON.stringify(customers);
 custName.value="";
 renderCustomers();
}

function renderCustomers(){
 customerList.innerHTML="";
 customerSelect.innerHTML="";
 customers.forEach((c,i)=>{
  customerList.innerHTML+=`<div>${c.name} | ${c.balance}</div>`;
  customerSelect.innerHTML+=`<option value="${i}">${c.name}</option>`;
 });
}

function renderReports(){
 let today=new Date().toISOString().slice(0,10);
 let d=invoices.filter(i=>i.date.startsWith(today));
 dayReport.innerHTML=`Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: ${d.length}<br>Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${d.reduce((a,i)=>a+i.net,0)}`;
}

function toggleCustomer(){
 customerSelect.classList.toggle("hidden",payType.value!="credit");
}

function scanBarcode(){
 alert("Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø±Ø¦ Ø®Ø§Ø±Ø¬ÙŠ");
}

const productsBox=document.getElementById("products");
const totalDiv=document.getElementById("total");
const netDiv=document.getElementById("net");

renderProducts();
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(reg => {
    reg.onupdatefound = () => {
      const newWorker = reg.installing;
      newWorker.onstatechange = () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          location.reload();
        }
      };
    };
  });
}
</script>
</body>
</html>
