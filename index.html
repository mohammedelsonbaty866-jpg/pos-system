<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>POS System</title>

<style>
body{font-family:Tahoma;margin:0;background:#f1f5f9}
header{background:#020617;color:#fff;padding:12px;text-align:center;font-size:18px}
nav{display:flex;gap:5px;padding:5px}
button{padding:10px;border:0;border-radius:8px;background:#22c55e;color:#fff;font-size:14px}
input,select{padding:10px;width:100%;margin:5px 0;font-size:14px}
.hidden{display:none}
.card{background:#fff;padding:10px;border-radius:10px;margin:5px 0;border:1px solid #e5e7eb}
#invoice .card{display:flex;justify-content:space-between;align-items:center}
.total{font-size:18px;font-weight:bold;margin:10px 0}
#suggestions .card{cursor:pointer;background:#e5e7eb}
</style>
</head>

<body>

<header>Ù†Ø¸Ø§Ù… Ù†Ù‚Ø§Ø· Ø¨ÙŠØ¹</header>

<nav>
<button onclick="show('cashier')">ğŸ§¾ Ø§Ù„ÙƒØ§Ø´ÙŠØ±</button>
<button onclick="show('products')">ğŸ“¦ Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
<button onclick="show('customers')">ğŸ‘¤ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
</nav>

<input id="shopName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„" oninput="saveShop()">

<!-- Ø§Ù„ÙƒØ§Ø´ÙŠØ± -->
<div id="cashier">
<input id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù" oninput="smartSearch()">
<div id="suggestions"></div>

<input id="qty" type="number" value="1" min="1">

<select id="payType" onchange="toggleCustomer()">
<option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
<option value="credit">Ø¢Ø¬Ù„</option>
</select>

<select id="customer" class="hidden"></select>

<button onclick="addToCart()">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©</button>

<div id="invoice"></div>
<div class="total" id="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0</div>

<button onclick="printInvoice()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
<button onclick="saveInvoice()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
</div>

<!-- Ø§Ù„Ø£ØµÙ†Ø§Ù -->
<div id="products" class="hidden">
<h3>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</h3>
<input id="pn" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
<input id="pp" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
<input id="pc" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
<input id="ps" type="number" placeholder="Ø§Ù„Ù…Ø®Ø²ÙˆÙ†">
<button onclick="addProduct()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>
<div id="plist"></div>
</div>

<!-- Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
<div id="customers" class="hidden">
<h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</h3>
<input id="cn" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
<button onclick="addCustomer()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
<div id="clist"></div>
</div>

<script>
/* ====== Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====== */
let DB = JSON.parse(localStorage.pos || '{"products":[],"customers":[],"invoices":[]}');
let cart = [];

/* ====== Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© ====== */
function save(){ localStorage.pos = JSON.stringify(DB); }
function show(id){
 ["cashier","products","customers"].forEach(x=>document.getElementById(x).classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}

/* ====== Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ ====== */
function saveShop(){ localStorage.shopName = shopName.value; }
shopName.value = localStorage.shopName || "";

/* ====== Ø§Ù„Ø£ØµÙ†Ø§Ù ====== */
function addProduct(){
 if(!pn.value || pp.value<=0 || ps.value<0){
  alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
  return;
 }
 DB.products.push({
  id:Date.now(),
  name:pn.value.trim(),
  price:+pp.value,
  cost:+pc.value || 0,
  stock:+ps.value
 });
 pn.value=pp.value=pc.value=ps.value="";
 save();
 renderProducts();
}

function renderProducts(){
 plist.innerHTML="";
 DB.products.forEach(p=>{
  plist.innerHTML+=`
  <div class="card">
   ${p.name}<br>
   Ø³Ø¹Ø±: ${p.price} | Ù…Ø®Ø²ÙˆÙ†: ${p.stock}
  </div>`;
 });
}

/* ====== Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ====== */
function addCustomer(){
 if(!cn.value.trim()) return;
 DB.customers.push({
  id:Date.now(),
  name:cn.value.trim(),
  balance:0,
  locked:false
 });
 cn.value="";
 save();
 renderCustomers();
}

function renderCustomers(){
 clist.innerHTML="";
 customer.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„</option>";
 DB.customers.forEach(c=>{
  clist.innerHTML+=`<div class="card">${c.name} | Ø±ØµÙŠØ¯: ${c.balance}</div>`;
  if(!c.locked)
   customer.innerHTML+=`<option value="${c.id}">${c.name}</option>`;
 });
}

function toggleCustomer(){
 customer.classList.toggle("hidden", payType.value!=="credit");
}

/* ====== Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ ====== */
function smartSearch(){
 let q = search.value.trim();
 suggestions.innerHTML="";
 if(q.length===0) return;

 DB.products
 .filter(p=>p.name.includes(q))
 .forEach(p=>{
  suggestions.innerHTML+=`
   <div class="card" onclick="selectProduct('${p.name.replace(/'/g,"")}')">
    ${p.name} | ${p.price}
   </div>`;
 });
}

function selectProduct(name){
 search.value=name;
 suggestions.innerHTML="";
}

/* ====== Ø§Ù„ÙƒØ§Ø´ÙŠØ± ====== */
function addToCart(){
 let p = DB.products.find(x=>x.name===search.value);
 let q = +qty.value;

 if(!p){ alert("Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"); return; }
 if(q<=0 || p.stock<q){ alert("ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©"); return; }

 cart.push({...p,qty:q});
 p.stock-=q;

 search.value="";
 qty.value=1;
 suggestions.innerHTML="";
 renderInvoice();
 save();
}

function renderInvoice(){
 invoice.innerHTML="";
 let t=0;
 cart.forEach((i,idx)=>{
  t+=i.price*i.qty;
  invoice.innerHTML+=`
  <div class="card">
   ${i.name} Ã— ${i.qty}
   <button onclick="removeItem(${idx})">âŒ</button>
  </div>`;
 });
 total.innerText="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: "+t;
}

function removeItem(i){
 let it = cart.splice(i,1)[0];
 let p = DB.products.find(x=>x.id===it.id);
 if(p) p.stock+=it.qty;
 renderInvoice();
 save();
}

function saveInvoice(){
 if(cart.length===0){ alert("Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙØ§Ø±ØºØ©"); return; }

 let totalVal = cart.reduce((a,i)=>a+i.price*i.qty,0);

 if(payType.value==="credit"){
  let c = DB.customers.find(x=>x.id==customer.value);
  if(!c || c.locked){
   alert("Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ ØµØ­ÙŠØ­");
   return;
  }
  c.balance += totalVal;
 }

 DB.invoices.push({
  id:Date.now(),
  items:cart,
  total:totalVal,
  date:new Date().toLocaleString()
 });

 cart=[];
 renderInvoice();
 renderCustomers();
 save();
 alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©");
}

/* ====== Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ====== */
function printInvoice(){
 if(cart.length===0){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØªÙˆØ±Ø©"); return; }

 let shop = localStorage.shopName || "";
 let win = window.open("","print","width=300");

 let rows = cart.map(i=>`
 <div style="border:1px dashed #000;padding:5px;margin:3px 0">
 ${i.name}<br>
 ${i.qty} Ã— ${i.price} = ${i.qty*i.price}
 </div>`).join("");

 let totalVal = cart.reduce((a,i)=>a+i.price*i.qty,0);

 win.document.write(`
 <html><head>
 <style>body{font-family:Tahoma;font-size:12px}</style>
 </head><body>
 <h3 style="text-align:center">${shop}</h3>
 <hr>
 ${rows}
 <hr>
 <b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalVal}</b><br>
 ${new Date().toLocaleString()}
 <script>window.print();window.close()</script>
 </body></html>
 `);
 win.document.close();
}

/* ====== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ====== */
renderProducts();
renderCustomers();
</script>

</body>
</html>
